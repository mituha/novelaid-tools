# Novelaid Tools プラグイン仕様書

## 概要

Novelaid Toolsは、Obsidianでの小説執筆を支援するためのプラグインです。
カクヨム記法のルビ・傍点をエディタ上でレンダリングする機能や、AIを活用した執筆支援機能を提供します。

---

## 現在利用可能な機能

### カクヨム記法のレンダリング支援（ルビ・傍点）

Markdownファイル内にカクヨム記法で記述されたルビ（振り仮名）と傍点を、Obsidianの閲覧モードでHTMLタグに自動的に変換して表示します。
この機能は[カクヨムのヘルプセンター](https://kakuyomu.jp/help/entry/notation)で説明されている記法に準拠しています。

#### 書式

##### ルビ

1.  **区切り文字を使用する方法**
    -   **書式**: `|親文字《ルビ》` または `｜親文字《ルビ》`
    -   **説明**: 親文字の前に半角または全角の縦線 `|` を入れます。この方法では、漢字、ひらがな、カタカナ、英数字など、あらゆる文字を親文字にできます。
    -   **例**: `|etc《えとせとら》` → `<ruby>etc<rt>えとせとら</rt></ruby>`

2.  **区切り文字を使用しない方法**
    -   **書式**: `親文字《ルビ》`
    -   **説明**: 親文字が**漢字のみ**で構成されている場合、区切り文字なしでルビを振ることができます。
    -   **例**: `彼女《ヒロイン》` → `<ruby>彼女<rt>ヒロイン</rt></ruby>`

##### 傍点

-   **書式**: `《《対象文字列》》`
-   **説明**: 傍点を振りたい文字列を二重の二重山括弧 `《《》》` で囲みます。
-   **出力 (HTML)**: `<em class="emphasis-dot">対象文字列</em>`
    -   傍点の表示は、プラグインに含まれる`styles.css`で定義されたCSSによって制御されます。

#### 実装

-   変換処理は `services/rubyTextFormatter.ts` 内の `applyRubyToElement` 関数で実装されています。
-   この関数は、指定されたHTML要素内のテキストを走査し、カクヨム記法をHTMLタグに変換します。
-   `main.ts` の `registerMarkdownPostProcessor` 内で `applyRubyToElement` が呼び出され、Markdownのレンダリング時に自動的に変換が適用されます。

### AIチャット

編集中のドキュメントの内容をコンテキストとして、AIと対話できるチャットパネルを提供します。

- **アクセス方法**: サイドバーのリボンに追加された「AIチャット」アイコンをクリックすると、右側のサイドバーにチャットパネルが開きます。
- **機能**:
    1.  チャットパネル下部の入力ボックスに質問や指示を入力し、「送信」ボタンまたはEnterキーでメッセージを送信します。
    2.  送信時、現在アクティブなエディタの全文がコンテキストとしてAIに送信されます。
    3.  AIからの応答がチャットパネルに表示されます。
- **ユースケース**:
    -   文章の続きのアイデアを求める。
    -   キャラクターのセリフ��提案してもらう。
    -   文章の校正や表現の改善を依頼する。
    -   文脈に基づいた事実確認や調査。

#### 実装

-   **UI**: `ui/ChatView.ts` で実装されています。このビューはObsidianの`ItemView`を拡張したものです。
-   **AI通信**: `services/geminiService.ts`内の`generateChatResponse`関数が、プロンプトを構築しGemini APIと通信します。
    -   **使用モデル**: `gemini-1.5-flash`
    -   **ライブラリ**: `@google/genai`
-   **プロンプト**: `generateChatResponse`関数内で、以下の構造のプロンプトが生成されます。
    ```
    あなたは優秀な文章アシスタントです。
    ユーザーは以下の文章を編集中です

    ---
    {編集中ファイルの全文}
    ---

    この文脈を踏まえて、ユーザーの次の質問に日本語で回答してください。

    質問: "{ユーザーの入力}"
    ```

---

## クラス・ファイル構成

- `main.ts` (`NovelaidToolsPlugin`): プラグインのメインクラス。イベントリスナーやコマンド、ビューを登録します。
- `novelaidToolsSettings.ts`: プラグインの設定を管理するインターフェースとデフォルト設定。
- `novelaidToolsSettingsTab.ts`: 設定画面のUIを構築するクラス。
- `services/geminiService.ts`: `@google/genai`ライブラリを使用し、Gemini APIとの通信を担当するサービスクラス。
- `services/rubyTextFormatter.ts`: ルビ・傍点変換処理を実装。
- `ui/ChatView.ts`: AIチャット機能のUIを実装するビュークラス。

---

本仕様は現在の実装と今後の開発計画に基づいています。
